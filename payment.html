<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - ONE⚡CASH</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>ONE⚡CASH</h1>
            </div>
            <nav class="nav">
                <a href="faq.html">FAQ</a>
                <a href="privacy.html">Privacy</a>
                <a href="support.html">Support</a>
            </nav>
        </div>
    </header>

    <!-- Payment Section -->
    <section class="payment-section">
        <div class="container">
            <div class="payment-box">
                <h2>Complete Your Payment</h2>
                
                <!-- Timer -->
                <div class="timer-box">
                    <div class="timer-label">Complete payment within:</div>
                    <div class="timer" id="timer">10:00</div>
                </div>

                <!-- Payment Status -->
                <div class="status-box" id="statusBox">
                    <div class="status-icon" id="statusIcon">⏳</div>
                    <div class="status-text" id="statusText">Waiting for payment...</div>
                </div>
                <!-- Removed demo mode warning as per user request -->
                <!-- Added real payment badge -->
                <div class="real-payment-badge">
                    <div class="real-icon">✅</div>
                    <div>
                        <strong>Real Payment Processing</strong>
                        <small>This is a live transaction. Please complete your payment within the time limit.</small>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="payment-details">
                    <div class="detail-row">
                        <span class="label">You Send:</span>
                        <span class="value" id="sendInfo">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">You Receive:</span>
                        <span class="value" id="receiveInfo">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Receive Method:</span>
                        <span class="value" id="receiveMethod">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Receiving Wallet:</span>
                        <span class="value wallet-address" id="receiveWallet">--</span>
                    </div>
                </div>

                <!-- Payment Address & QR Code -->
                <div class="payment-address-box">
                    <h3>Send Payment to This Address:</h3>
                    <div class="qr-code-wrapper">
                        <div class="qr-code-container">
                            <div class="qr-code" id="qrCode">
                                <!-- QR Code will be generated here -->
                            </div>
                        </div>
                    </div>
                    <div class="address-display">
                        <input type="text" id="paymentAddress" readonly>
                        <button class="btn-copy" onclick="copyAddress()">Copy Address</button>
                    </div>
                    <p class="warning">⚠️ Send only <span id="coinType">--</span> to this address. Sending other coins may result in loss.</p>
                </div>

                <!-- Order ID -->
                <div class="order-id">
                    <span>Order ID: <strong id="orderId">--</strong></span>
                </div>

                <!-- Back Button -->
                <a href="index.html" class="btn-back">← Back to Home</a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>ONE⚡CASH</h3>
                    <p>© 2018–2024 CCE Cash. All rights reserved.</p>
                </div>
                <div class="footer-col">
                    <h4>Popular</h4>
                    <ul>
                        <li><a href="index.html#exchange">USDT-TRC20 to USDT-ERC20</a></li>
                        <li><a href="index.html#exchange">USDT-TRC20 to ETH</a></li>
                        <li><a href="index.html#exchange">USDT-ERC20 to ETH</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Legal & Support</h4>
                    <ul>
                        <li><a href="terms.html">Terms of Service</a></li>
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="support.html">Support</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        // Get order ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');

        // For local preview, we'll use mock data if no order ID or if fetch fails
        const mockOrder = {
            order_id: orderId || 'ORD1234567890',
            amount: 0.1,
            coin: 'BTC',
            usd_value: 5000,
            receive_method: 'USDT-TRC20',
            receive_wallet: 'TABC1234567890XYZ',
            payment_address: '1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa',
            status: 'pending'
        };

        if (!orderId) {
            // Use mock data for local preview
            populatePaymentDetails(mockOrder);
        }

        // Load payment details
        async function loadPaymentDetails() {
            try {
                // Check if we're in local development and have mock data
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                if (isLocal) {
                    // Try to get mock order data from sessionStorage
                    const storedMockOrder = sessionStorage.getItem('mockOrder');
                    if (storedMockOrder) {
                        const order = JSON.parse(storedMockOrder);
                        populatePaymentDetails(order);
                        return;
                    }
                }
                
                // Use direct Cloudflare Worker API endpoint since we have separate repositories
                // Use the configured worker URL
                const workerUrl = window.CONFIG.WORKER_URL;
                const apiPath = '/api/order/';
                const response = await fetch(`${workerUrl}${apiPath}${orderId}`);
                
                // Check if response is OK
                if (!response.ok) {
                    console.error('API Error:', response.status, response.statusText);
                    // Use mock data for local preview
                    populatePaymentDetails(mockOrder);
                    return;
                }
                
                const data = await response.json();

                if (data.success) {
                    populatePaymentDetails(data.order);
                } else {
                    // Use mock data if API call fails
                    populatePaymentDetails(mockOrder);
                }
            } catch (error) {
                console.error('Error loading payment details:', error);
                // Use mock data if API call fails
                populatePaymentDetails(mockOrder);
            }
        }

        // Populate payment details in the UI
        function populatePaymentDetails(order) {
            // Update UI
            document.getElementById('orderId').textContent = order.order_id;
            document.getElementById('sendInfo').textContent = `${order.amount} ${order.coin}`;
            document.getElementById('receiveInfo').textContent = `${order.usd_value} USD`;
            document.getElementById('receiveMethod').textContent = order.receive_method;
            document.getElementById('receiveWallet').textContent = order.receive_wallet;
            document.getElementById('paymentAddress').value = order.payment_address;
            document.getElementById('coinType').textContent = order.coin;

            // Generate QR Code with optimized settings
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = ''; // Clear previous content
            const canvas = document.createElement('canvas');
            qrContainer.appendChild(canvas);
            
            // Use optimized QR code settings for faster generation
            QRCode.toCanvas(
                canvas,
                order.payment_address,
                { 
                    width: 180, 
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    },
                    quality: 0.8,
                    errorCorrectionLevel: 'M'
                },
                function (error) {
                    if (error) {
                        console.error('QR Code Error:', error);
                        qrContainer.innerHTML = '<p style="color: #666;">QR Code unavailable. Please use the address below.</p>';
                    }
                }
            );

            // Update status
            updateStatus(order.status);

            // Start polling for status updates
            startStatusPolling();
        }

        // Update status display
        function updateStatus(status) {
            const statusBox = document.getElementById('statusBox');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');

            if (status === 'paid') {
                statusBox.className = 'status-box success';
                statusIcon.textContent = '✅';
                statusText.textContent = 'Payment Received!';
                stopTimer();
            } else if (status === 'pending') {
                statusBox.className = 'status-box pending';
                statusIcon.textContent = '⏳';
                statusText.textContent = 'Waiting for payment...';
            } else if (status === 'expired') {
                statusBox.className = 'status-box expired';
                statusIcon.textContent = '❌';
                statusText.textContent = 'Payment expired';
                stopTimer();
            }
        }

        // Poll for status updates with exponential backoff
        let statusInterval;
        let pollCount = 0;
        function startStatusPolling() {
            const poll = async () => {
                try {
                    // Check if we're in local development
                    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    
                    if (isLocal) {
                        // For local preview, we'll just simulate status changes
                        // In a real implementation, this would call the backend API
                        console.log('Polling for status updates...');
                        return;
                    }
                    
                    // Use direct Cloudflare Worker API endpoint since we have separate repositories
                    // Use the configured worker URL
                    const workerUrl = window.CONFIG.WORKER_URL;
                    const apiPath = '/api/order/';
                    const response = await fetch(`${workerUrl}${apiPath}${orderId}`);
                    
                    // Check if response is OK
                    if (!response.ok) {
                        console.error('Status check failed:', response.status, response.statusText);
                        return;
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        updateStatus(data.order.status);
                        if (data.order.status === 'paid' || data.order.status === 'expired') {
                            clearInterval(statusInterval);
                        }
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            };
            
            // Start immediate check
            poll();
            
            // Then set up polling with exponential backoff
            // Start with 5 seconds, then increase to 10s, 15s, etc.
            statusInterval = setInterval(() => {
                pollCount++;
                const interval = Math.min(5000 + (pollCount * 2000), 30000); // Max 30 seconds
                poll();
                
                // Reset interval if we get a positive status
                if (document.getElementById('statusBox').className.includes('success') || 
                    document.getElementById('statusBox').className.includes('expired')) {
                    clearInterval(statusInterval);
                }
            }, 5000);
        }

        // Timer countdown (10 minutes) with performance optimization
        let timeLeft = 600; // 10 minutes in seconds
        let timerInterval;
        let lastUpdate = 0;

        function startTimer() {
            // Use high-performance timer
            const startTime = performance.now();
            
            timerInterval = setInterval(() => {
                const now = performance.now();
                
                // Only update UI when necessary
                if (now - lastUpdate >= 1000) {
                    timeLeft--;
                    
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    
                    document.getElementById('timer').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;

                    if (timeLeft <= 0) {
                        stopTimer();
                        updateStatus('expired');
                    }
                    
                    lastUpdate = now;
                }
            }, 100); // Check more frequently but only update when needed
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        // Copy address to clipboard
        function copyAddress() {
            const addressInput = document.getElementById('paymentAddress');
            addressInput.select();
            addressInput.setSelectionRange(0, 99999); // For mobile devices
            
            // Modern clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(addressInput.value).then(() => {
                    showCopyFeedback('Address copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    // Fallback to old method
                    document.execCommand('copy');
                    showCopyFeedback('Address copied to clipboard!');
                });
            } else {
                // Fallback for older browsers
                document.execCommand('copy');
                showCopyFeedback('Address copied to clipboard!');
            }
        }
        
        // Show copy feedback without interrupting user
        function showCopyFeedback(message) {
            const originalText = document.querySelector('.btn-copy').textContent;
            document.querySelector('.btn-copy').textContent = 'Copied!';
            setTimeout(() => {
                document.querySelector('.btn-copy').textContent = originalText;
            }, 2000);
        }

        // Initialize with better performance
        document.addEventListener('DOMContentLoaded', () => {
            loadPaymentDetails();
            startTimer();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopTimer();
            if (statusInterval) clearInterval(statusInterval);
        });
        
        // Handle page visibility changes to reduce resource usage
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, reduce polling frequency
                if (statusInterval) {
                    clearInterval(statusInterval);
                    // Restart with longer interval
                    statusInterval = setInterval(() => {
                        // Minimal check when page is hidden
                    }, 30000);
                }
            } else {
                // Page is visible, resume normal polling
                if (statusInterval) {
                    clearInterval(statusInterval);
                    startStatusPolling();
                }
            }
        });
    </script>
</body>
</html>