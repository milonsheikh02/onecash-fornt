<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - ONE⚡CASH</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>ONE⚡CASH</h1>
            </div>
            <nav class="nav">
                <a href="index.html">Home</a>
                <a href="faq.html">FAQ</a>
                <a href="privacy.html">Privacy</a>
                <a href="support.html">Support</a>
            </nav>
        </div>
    </header>

    <!-- Payment Section -->
    <section class="payment-section">
        <div class="container">
            <div class="payment-box">
                <h2>Complete Your Payment</h2>
                
                <!-- Timer -->
                <div class="timer-box">
                    <div class="timer-label">Complete payment within:</div>
                    <div class="timer" id="timer">10:00</div>
                </div>

                <!-- Payment Status -->
                <div class="status-box" id="statusBox">
                    <div class="status-icon" id="statusIcon">⏳</div>
                    <div class="status-text" id="statusText">Waiting for payment...</div>
                </div>

                <!-- Payment Details -->
                <div class="payment-details">
                    <div class="detail-row">
                        <span class="label">You Send:</span>
                        <span class="value" id="sendInfo">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">You Receive:</span>
                        <span class="value" id="receiveInfo">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Receive Method:</span>
                        <span class="value" id="receiveMethod">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Receiving Wallet:</span>
                        <span class="value wallet-address" id="receiveWallet">--</span>
                    </div>
                </div>

                <!-- Payment Address & QR Code -->
                <div class="payment-address-box">
                    <h3>Send Payment to This Address:</h3>
                    <div class="qr-code" id="qrCode">
                        <!-- QR Code will be generated here -->
                    </div>
                    <div class="address-display">
                        <input type="text" id="paymentAddress" readonly>
                        <button class="btn-copy" onclick="copyAddress()">Copy</button>
                    </div>
                    <p class="warning">⚠️ Send only <span id="coinType">--</span> to this address. Sending other coins may result in loss.</p>
                </div>

                <!-- Order ID -->
                <div class="order-id">
                    <span>Order ID: <strong id="orderId">--</strong></span>
                </div>

                <!-- Back Button -->
                <a href="index.html" class="btn-back">← Back to Home</a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>ONE⚡CASH</h3>
                    <p>© 2018–2024 CCE Cash. All rights reserved.</p>
                </div>
                <div class="footer-col">
                    <h4>Popular</h4>
                    <ul>
                        <li><a href="index.html#exchange">USDT-TRC20 to USDT-ERC20</a></li>
                        <li><a href="index.html#exchange">USDT-TRC20 to ETH</a></li>
                        <li><a href="index.html#exchange">USDT-ERC20 to ETH</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Legal & Support</h4>
                    <ul>
                        <li><a href="terms.html">Terms of Service</a></li>
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="support.html">Support</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        // Get order ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');

        if (!orderId) {
            alert('Invalid order ID');
            window.location.href = 'index.html';
        }

        // Load payment details
        async function loadPaymentDetails() {
            try {
                const response = await fetch(`/api/order/${orderId}`);
                const data = await response.json();

                if (data.success) {
                    const order = data.order;
                    
                    // Update UI
                    document.getElementById('orderId').textContent = order.order_id;
                    document.getElementById('sendInfo').textContent = `${order.amount} ${order.coin}`;
                    document.getElementById('receiveInfo').textContent = `${order.usd_value} USD`;
                    document.getElementById('receiveMethod').textContent = order.receive_method;
                    document.getElementById('receiveWallet').textContent = order.receive_wallet;
                    document.getElementById('paymentAddress').value = order.payment_address;
                    document.getElementById('coinType').textContent = order.coin;

                    // Generate QR Code
                    const qrContainer = document.getElementById('qrCode');
                    qrContainer.innerHTML = ''; // Clear previous content
                    const canvas = document.createElement('canvas');
                    qrContainer.appendChild(canvas);
                    
                    QRCode.toCanvas(
                        canvas,
                        order.payment_address,
                        { width: 200, margin: 2 },
                        function (error) {
                            if (error) {
                                console.error('QR Code Error:', error);
                                qrContainer.innerHTML = '<p style="color: #666;">QR Code generation failed. Please use the address below.</p>';
                            }
                        }
                    );

                    // Update status
                    updateStatus(order.status);

                    // Start polling for status updates
                    startStatusPolling();
                } else {
                    alert('Order not found');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error loading payment details:', error);
                alert('Error loading payment details');
            }
        }

        // Update status display
        function updateStatus(status) {
            const statusBox = document.getElementById('statusBox');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');

            if (status === 'paid') {
                statusBox.className = 'status-box success';
                statusIcon.textContent = '✅';
                statusText.textContent = 'Payment Received!';
                stopTimer();
            } else if (status === 'pending') {
                statusBox.className = 'status-box pending';
                statusIcon.textContent = '⏳';
                statusText.textContent = 'Waiting for payment...';
            } else if (status === 'expired') {
                statusBox.className = 'status-box expired';
                statusIcon.textContent = '❌';
                statusText.textContent = 'Payment expired';
                stopTimer();
            }
        }

        // Poll for status updates
        let statusInterval;
        function startStatusPolling() {
            statusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/order/${orderId}`);
                    const data = await response.json();
                    if (data.success) {
                        updateStatus(data.order.status);
                        if (data.order.status === 'paid' || data.order.status === 'expired') {
                            clearInterval(statusInterval);
                        }
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 5000); // Check every 5 seconds
        }

        // Timer countdown (10 minutes)
        let timeLeft = 600; // 10 minutes in seconds
        let timerInterval;

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    stopTimer();
                    updateStatus('expired');
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        // Copy address to clipboard
        function copyAddress() {
            const addressInput = document.getElementById('paymentAddress');
            addressInput.select();
            document.execCommand('copy');
            alert('Address copied to clipboard!');
        }

        // Initialize
        loadPaymentDetails();
        startTimer();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopTimer();
            if (statusInterval) clearInterval(statusInterval);
        });
    </script>
</body>
</html>
