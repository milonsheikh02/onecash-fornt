<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - ONEâš¡CASH</title>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>ONEâš¡CASH</h1>
            </div>
            <nav class="nav">
                <a href="faq.html">FAQ</a>
                <a href="privacy.html">Privacy</a>
                <a href="support.html">Support</a>
            </nav>
        </div>
    </header>
    
    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1>Fast, Secure & Anonymous Crypto Exchange</h1>
            <p>Instant cross-chain swaps â€” no account required. Send, confirm, and receive in minutes.</p>
        </div>
    </section>
    
    
            <div class="content">
                <div class="info-grid">
                    <div class="info-card">
                        <h3>You Send</h3>
                        <p id="sendAmount">0.00</p>
                        <p id="sendCoin">COIN</p>
                    </div>
                    
                    <div class="info-card">
                        <h3>You Receive</h3>
                        <p id="receiveAmount">0.00</p>
                        <p id="receiveCoin">USDT</p>
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>Your Order ID</h3>
                        <p id="orderId">Loading...</p>
                    </div>
                    
                    <div class="info-card">
                        <h3>Receive Address</h3>
                        <p id="receiveWallet">Loading...</p>
                    </div>
                </div>
                
                <div class="address-section">
                    <h3>Send Payment To This Address</h3>
                    <div class="network-info" id="networkInfo"></div>
                    <div class="address" id="paymentAddress">Generating address...</div>
                    <button class="btn btn-secondary" id="copyPaymentAddressBtn">Copy Payment Address</button>
                    <div class="qr-placeholder" id="qrCodeContainer">
                        <span>QR Code Placeholder<br>(Address QR would appear here)</span>
                    </div>
                    <p>Send exactly <strong id="exactAmount">0.00</strong> <span id="coinType">COIN</span> to this address</p>
                </div>
                
                <div class="status-section">
                    <h3>Payment Status</h3>
                    <div>
                        <span class="status-indicator status-pending" id="statusIndicator"></span>
                        <span id="statusText">Pending Payment</span>
                    </div>
                    <div class="timer" id="timer">10:00</div>
                    <p id="statusMessage">Please send your payment within the time limit</p>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" id="checkPaymentBtn">Check Payment Status</button>
                    <button class="btn btn-success" id="completeBtn" style="display: none;">Complete Exchange</button>
                </div>
                
                <!-- Important Information -->
                <div class="important-info">
                    <h3>What do you need to know?</h3>
                    <ul>
                        <li>ðŸ‘‰ You only need 5 confirmation for the exchange.</li>
                        <li>ðŸ‘‰ If the amount of the transaction you sent differs from the initial amount specified in the order with a float rate, the order will be automatically recalculated.</li>
                        <li>ðŸ‘‰ If your payment time exceeds 30 minutes and the order has expired, your payment transaction will not take effect at this time, please contact customer service to return your relevant funds.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
        
    <!-- Footer -->
    <footer id="privacy" class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>ONEâš¡CASH</h3>
                    <p>Â© 2018â€“2024 CCE Cash. All rights reserved.</p>
                </div>
                <div class="footer-col">
                    <h4>Popular</h4>
                    <ul>
                        <li><a href="index.html#exchange">USDT-TRC20 to USDT-ERC20</a></li>
                        <li><a href="index.html#exchange">USDT-TRC20 to ETH</a></li>
                        <li><a href="index.html#exchange">USDT-ERC20 to ETH</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Legal & Support</h4>
                    <ul>
                        <li><a href="terms.html">Terms of Service</a></li>
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="support.html">Support</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
        
    <script>
        // Get order data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');
        
        // DOM elements
        const sendAmountEl = document.getElementById('sendAmount');
        const sendCoinEl = document.getElementById('sendCoin');
        const receiveAmountEl = document.getElementById('receiveAmount');
        const receiveCoinEl = document.getElementById('receiveCoin');
        const orderIdEl = document.getElementById('orderId');
        const receiveWalletEl = document.getElementById('receiveWallet');
        const paymentAddressEl = document.getElementById('paymentAddress');
        const exactAmountEl = document.getElementById('exactAmount');
        const coinTypeEl = document.getElementById('coinType');
        const statusIndicatorEl = document.getElementById('statusIndicator');
        const statusTextEl = document.getElementById('statusText');
        const statusMessageEl = document.getElementById('statusMessage');
        const timerEl = document.getElementById('timer');
        const checkPaymentBtn = document.getElementById('checkPaymentBtn');
        const completeBtn = document.getElementById('completeBtn');
        
        // Check if we're in local development
        const isLocal = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' || 
                       window.location.hostname === '0.0.0.0' ||
                       window.location.hostname.includes('local') ||
                       window.location.hostname.includes('preview');
        
        // Use local API endpoint if in development, otherwise use production
        const apiBaseUrl = isLocal ? 'http://localhost:8787' : 'https://api.onncx.com';
        
        // Timer variables
        let timeLeft = 1200; // 20 minutes in seconds
        let timerInterval;
        
        // Initialize page
        async function init() {
            // Check if we're in local development
            const isLocal = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' || 
                           window.location.hostname === '0.0.0.0' ||
                           window.location.hostname.includes('local') ||
                           window.location.hostname.includes('preview');
            
            // Use local API endpoint if in development, otherwise use production
            const apiBaseUrl = isLocal ? 'http://localhost:8787' : 'https://api.onncx.com';
            
            if (isLocal) {
                // In local development, use mock order data from sessionStorage
                const mockOrderStr = sessionStorage.getItem('mockOrder');
                if (mockOrderStr) {
                    try {
                        const order = JSON.parse(mockOrderStr);
                        
                        // Update UI with mock order details
                        sendAmountEl.textContent = order.amount.toFixed(6);
                        sendCoinEl.textContent = order.coin;
                        receiveAmountEl.textContent = order.usd_value.toFixed(2);
                        receiveCoinEl.textContent = 'USDT';
                        receiveWalletEl.textContent = order.receive_wallet;
                        
                        // Show actual wallet address based on coin
                        const walletAddresses = {
                            'ETH': '0x2bb183CC12315a2acd0bfA89e815E1fC2C58815B',
                            'BTC': 'bc1qk263esw8mxpcmmml0mus7nfnscp9fryyqqzgwq',
                            'TRX': 'TUop15AqkgbB7uXjiHDp1XDpDfBJEQUB7w'
                        };
                        
                        const networkInfo = {
                            'ETH': 'ERC20 Network',
                            'BTC': 'Bitcoin Network',
                            'TRX': 'TRC20 Network'
                        };
                        
                        const paymentAddress = walletAddresses[order.coin] || order.payment_address;
                        paymentAddressEl.textContent = paymentAddress;
                        document.getElementById('networkInfo').textContent = networkInfo[order.coin] || '';
                        
                        exactAmountEl.textContent = order.amount.toFixed(6);
                        coinTypeEl.textContent = order.coin;
                        orderIdEl.textContent = order.order_id;
                        
                        // Generate QR code for the payment address
                        generateQRCode(paymentAddress);
                        
                        // Start timer
                        startTimer();
                        
                        // Start polling for payment status
                        startStatusPolling();
                    } catch (error) {
                        console.error('Error parsing mock order:', error);
                        alert('Error loading order details');
                    }
                } else {
                    alert('No order data found. Please go back and create an exchange.');
                }
            } else {
                // In production, fetch order data from API
                if (!orderId) {
                    alert('No order ID provided');
                    return;
                }
                
                orderIdEl.textContent = orderId;
                
                // Fetch order details
                try {
                    const response = await fetch(`${apiBaseUrl}/api/order/${orderId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const order = data.order;
                        
                        // Update UI with order details
                        sendAmountEl.textContent = order.send_amount.toFixed(6);
                        sendCoinEl.textContent = order.send_network;
                        receiveAmountEl.textContent = order.receive_amount.toFixed(2);
                        receiveCoinEl.textContent = order.receive_network;
                        receiveWalletEl.textContent = order.receive_wallet;
                        
                        // Show actual wallet address based on coin
                        const walletAddresses = {
                            'ETH': '0x2bb183CC12315a2acd0bfA89e815E1fC2C58815B',
                            'BTC': 'bc1qk263esw8mxpcmmml0mus7nfnscp9fryyqqzgwq',
                            'TRX': 'TUop15AqkgbB7uXjiHDp1XDpDfBJEQUB7w'
                        };
                        
                        const networkInfo = {
                            'ETH': 'ERC20 Network',
                            'BTC': 'Bitcoin Network',
                            'TRX': 'TRC20 Network'
                        };
                        
                        const paymentAddress = walletAddresses[order.send_network] || order.deposit_address;
                        paymentAddressEl.textContent = paymentAddress;
                        document.getElementById('networkInfo').textContent = networkInfo[order.send_network] || '';
                        
                        exactAmountEl.textContent = order.send_amount.toFixed(6);
                        coinTypeEl.textContent = order.send_network;
                        
                        // Generate QR code for the payment address
                        generateQRCode(paymentAddress);
                        
                        // Start timer
                        startTimer();
                        
                        // Start polling for payment status
                        startStatusPolling();
                    } else {
                        alert('Error loading order: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error fetching order:', error);
                    alert('Error loading order details');
                }
            }
        }
        
        // Start countdown timer
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerEl.textContent = 'EXPIRED';
                    timerEl.style.color = '#dc3545';
                    statusMessageEl.textContent = 'Order expired. Please create a new exchange.';
                    checkPaymentBtn.disabled = true;
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Poll for status updates
        function startStatusPolling() {
            const poll = async () => {
                try {
                    const response = await fetch(`${apiBaseUrl}/api/check-payment/${orderId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        updateStatus(data.status);
                    }
                } catch (error) {
                    console.error('Error checking payment status:', error);
                }
            };
            
            // Check every 10 seconds
            setInterval(poll, 10000);
        }
        
        // Update status display
        function updateStatus(status) {
            if (status === 'paid') {
                statusIndicatorEl.className = 'status-indicator status-paid';
                statusTextEl.textContent = 'Payment Received';
                statusMessageEl.textContent = 'Your exchange is being processed!';
                checkPaymentBtn.style.display = 'none';
                completeBtn.style.display = 'inline-block';
            } else {
                statusIndicatorEl.className = 'status-indicator status-pending';
                statusTextEl.textContent = 'Pending Payment';
                statusMessageEl.textContent = 'Please send your payment within the time limit';
            }
        }
        
        // Check payment manually
        checkPaymentBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`${apiBaseUrl}/api/check-payment/${orderId}`);
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(data.status);
                    
                    if (data.status === 'paid') {
                        alert('Payment confirmed! Your exchange is being processed.');
                    } else {
                        alert('Payment not yet received. Please try again in a few moments.');
                    }
                } else {
                    alert('Error checking payment: ' + data.error);
                }
            } catch (error) {
                console.error('Error checking payment:', error);
                alert('Error checking payment status');
            }
        });
        
        // Complete exchange
        completeBtn.addEventListener('click', () => {
            alert('Exchange completed successfully! Your USDT will be sent to your wallet shortly.');
            window.location.href = '/';
        });
        
        // Generate QR code for payment address
        function generateQRCode(address) {
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            
            // Clear the container
            qrCodeContainer.innerHTML = '';
            
            // Generate QR code using the library
            new QRCode(qrCodeContainer, {
                text: address,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
        
        // Copy payment address to clipboard
        document.getElementById('copyPaymentAddressBtn').addEventListener('click', function() {
            const paymentAddressElement = document.getElementById('paymentAddress');
            const paymentAddressText = paymentAddressElement ? paymentAddressElement.textContent : '';
            
            if (paymentAddressText && paymentAddressText !== 'Generating address...') {
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(paymentAddressText).then(function() {
                        // Show feedback
                        const button = document.getElementById('copyPaymentAddressBtn');
                        const originalText = button.textContent;
                        button.textContent = 'Copied!';
                        setTimeout(function() {
                            button.textContent = originalText;
                        }, 2000);
                    }).catch(function(err) {
                        console.error('Could not copy text: ', err);
                        // Fallback to old method
                        fallbackCopyTextToClipboard(paymentAddressText);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopyTextToClipboard(paymentAddressText);
                }
            } else {
                alert('Payment address not available yet');
            }
        });
        
        // Fallback copy method for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const button = document.getElementById('copyPaymentAddressBtn');
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(function() {
                        button.textContent = originalText;
                    }, 2000);
                } else {
                    alert('Failed to copy address to clipboard');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert('Failed to copy address to clipboard');
            }
            
            document.body.removeChild(textArea);
        }
    </script>
    <script src="config.js"></script>
    <script src="script.js"></script>
    <script src="web3-wallet.js"></script>
